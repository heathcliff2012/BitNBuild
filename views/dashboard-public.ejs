<!DOCTYPE html>
<html lang="en" class="auraFlow">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraFlow: The Verifiable Ledger</title>
    <link rel="icon" href="">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* Define theme variables */
        :root {
            --background: radial-gradient(circle at 20% 30%, #2563eb, #22c55e);
            --foreground: rgba(0,0,0,0.2);
            --text-primary: #f8fafc;
            --text-secondary: #d1fae5;
            --accent: #06b6d4;
            --highlight: #fcd34d;
            --danger: #f87171; /* Maintained for alert consistency */
            font-family: 'Inter', sans-serif;
        }

        /* Apply theme variables */
        body {
            background-color: #0b1120; /* Fallback for gradient */
            background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PGcgZmlsbC1ydWxlPSdldmVub2RkJz48ZyBmaWxsPScjZjhmYWZjJyBmaWxsLW9wYWNpdHk9JzAuMDUnPjxwYXRoIG9wYWNpdHk9Jy41JyBkPSdNOTYgOTVoNHYxaC00djRoLTF2LTRoLTl2NGgtMXYtNGgtOXY0aC0xdi00aC05djRoLTF2LTRoLTl2NGgtMXYtNGgtOXY0aC0xdi00aC05djRoLTF2LTRoLTl2NGgtMXYtNGgtNHYtMWg0di05aC00di0xaDR2LTloLTR2LTFoNHYtOWgtNHYtMWg0di05aC00di0xaDR2LTloLTR2LTFoNHYtOWgtNHYtMWg0di05aC00di0xaDR2LTRoMXY0aDl2LTRoMXY0aDl2LTRoMXY0aDl2LTRoMXY0aDl2LTRoMXY0aDl2LTRoMXY0aDl2LTRoMXY0aDR2MWgtNHY5aDR2MWgtNHY5aDR2MWgtNHY5aDR2MWgtNHY5aDR2MWgtNHY5aDR2MWgtNHY5aDR2MWgtNHY5aDR2MUg2di05SDB2LTFoNnYtOUgwdi0xaDZ2LTlIMHYtMWg2di05SDB2LTFoNnYtOUgwdi0xaDZ2LTlIMHYtMWg2VjV6Jy8+PHBhdGggZD0nTTYgNVYwaDF2NWg5VjBoMXY1aDlWMGgxdiVoOVYwaDF2NWg5VjBoMXY1aDlWMGgxdiVoOVYwaDF2NWg0djFoLTR2OWg0djFoLTR2OWg0djFoLTR2OWg0djFoLTR2OWg0djFoLTR2OWg0djFoLTR2OWg0djFIOHYtOUgwdi0xaDZ2LTlIMHYtMWg2di05SDB2LTFoNnYtOUgwdi0xaDZ2LTlIMHYtMWg2di05SDB2LTFoNlYek0nLz48L2c+PC9nPjwvc3ZnPg=="), var(--background);
            background-attachment: fixed; /* Keep pattern stationary on scroll */
            color: var(--text-primary);
            background-size: 200% 200%;
            animation: gradient-flow 15s ease infinite;
        }
        .bg-foreground { background-color: var(--foreground); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--accent); }
        .bg-accent { background-color: var(--accent); }
        .border-accent { border-color: var(--accent); }
        .ring-accent { --tw-ring-color: var(--accent); }
        .text-highlight { color: var(--highlight); }
        .text-danger { color: var(--danger); }
        .shadow-accent { box-shadow: 0 10px 15px -3px var(--accent), 0 4px 6px -4px var(--accent); }

        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes subtle-glow {
            0%, 100% { box-shadow: 0 0 8px 2px rgba(6, 182, 212, 0.4); }
            50% { box-shadow: 0 0 16px 6px rgba(6, 182, 212, 0.7); }
        }

        /* Custom Animations */
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.5s ease-out forwards; }

        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scale-in { animation: scale-in 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }

        /* New Stunning Button Styles */
        .btn-primary-animated {
            position: relative;
            z-index: 1;
            overflow: hidden;
            border: 2px solid transparent;
            background-color: var(--accent);
            background-clip: padding-box;
        }
        .btn-primary-animated::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -2px; /* Match the border width */
            border-radius: inherit;
            background: conic-gradient(from 180deg at 50% 50%, #22c55e 0deg, #06b6d4 120deg, #fcd34d 240deg, #22c55e 360deg);
            animation: spin 4s linear infinite;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }
        .btn-primary-animated:hover::before {
            opacity: 1;
        }

        .btn-secondary-animated {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .btn-secondary-animated:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 20px -5px var(--accent);
            transform: translateY(-2px);
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .animate-shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        
        .animate-glow {
            animation: subtle-glow 3s ease-in-out infinite;
        }

        .card-glow {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-glow:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(6, 182, 212, 0.2), 0 0 15px rgba(6, 182, 212, 0.1);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--accent);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; }
        .prose li { margin-top: 0.5rem; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: 20px; }

        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Chatbot styles */
        #chatbot-window {
            transform-origin: bottom right;
            transition: transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1), opacity 0.3s ease-out;
            display: flex; /* Use flex instead of toggling display for animation */
        }
        #chatbot-window.hidden {
            transform: scale(0.5);
            opacity: 0;
            pointer-events: none;
        }
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: 10px; }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

    </style>
</head>
<body class="antialiased min-h-screen transition-colors duration-500">

    <canvas id="background-canvas"></canvas>

    <!-- Main Container -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- App Header Removed -->

        <!-- Dynamic Content Area -->
        <main id="content-area">
            <!-- Landing page / Dashboard will be rendered here -->
        </main>
    </div>

    <!-- Transaction Modal -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div id="modal-content" class="bg-foreground rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-scale-in p-6 sm:p-8 relative">
            <!-- Modal content will be rendered here -->
        </div>
    </div>

    <!-- Chatbot -->
    <div id="chatbot-container">
        <button id="chatbot-toggle" class="fixed bottom-6 right-6 bg-accent text-primary w-16 h-16 rounded-full shadow-lg flex items-center justify-center animate-glow z-40 btn-primary-animated hover:scale-110 transition-transform">
            <i data-lucide="message-circle" class="w-8 h-8"></i>
        </button>

        <div id="chatbot-window" class="fixed bottom-24 right-6 w-full max-w-sm h-full max-h-[600px] bg-foreground/80 backdrop-blur-lg rounded-2xl shadow-2xl flex-col z-40 hidden">
            <div class="p-4 bg-foreground rounded-t-2xl flex justify-between items-center border-b border-accent/20 flex-shrink-0">
                <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="bot" class="text-accent"></i> AuraFlow Assistant</h3>
                <button id="chatbot-close" class="text-secondary hover:text-primary"><i data-lucide="x"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                <!-- Welcome Message -->
                <div class="flex gap-2.5">
                    <div class="w-8 h-8 rounded-full bg-accent flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-5 h-5"></i></div>
                    <div class="bg-accent/20 p-3 rounded-lg max-w-xs text-sm">
                        <p>Hello! I'm the AuraFlow Assistant. Ask me anything about the financial data on your dashboard.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-accent/20 flex-shrink-0">
                <form id="chat-form" class="flex items-center gap-2">
                    <input type="text" id="chat-input" placeholder="Ask about your fees..." class="w-full bg-foreground/50 border border-accent/30 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 ring-accent text-primary transition">
                    <button type="submit" class="bg-accent text-primary p-2 rounded-lg hover:bg-accent/80 transition-colors"><i data-lucide="send"></i></button>
                </form>
            </div>
        </div>
    </div>


    <script type="module">
        const jsonData = {
            "projectConfig": {
                "projectName": "AuraFlow: Financial Clarity Platform",
                "version": "4.0.0-genesis",
                "branding": {
                    "logoLightUrl": "https://placehold.co/200x60/ffffff/0f172a?text=AuraFlow",
                    "logoDarkUrl": "https://placehold.co/200x60/0b1120/f8fafc?text=AuraFlow",
                    "faviconUrl": "https://placehold.co/32x32/22c55e/ffffff?text=A",
                    "tagline": "Transparency in Every Transaction."
                },
                "themes": {
                    "auraFlow": { "background": "radial-gradient(circle at 20% 30%,#2563eb,#22c55e)", "foreground": "rgba(0,0,0,0.2)", "textPrimary": "#f8fafc", "textSecondary": "#d1fae5", "accent": "#06b6d4", "highlight": "#fcd34d" }
                },
                "animations": { "tooltip": "fade-in", "button": "pulse-on-hover", "cardEntry": "slide-up", "alertHighlight": "shake", "graphFlow": "glow-trail", "modal": "scale-in" }
            },
            "landingPage": {
                "hero": {
                    "headline": "Transparency. Trust. Together.",
                    "subheadline": "Track every rupee from budget to impact with complete clarity.",
                    "callToActions": [
                         { "text": "View Infographics", "actionId": "view_infographics" }
                    ]
                }
            },
            "viewContext": {
                "userType": "student", "viewId": "student_priya_k", "userProfile": { "name": "Priya K.", "avatarUrl": "https://i.pravatar.cc/150?u=priya_k" }
            },
            "payload": {
                "studentView": {
                    "welcomeMessage": "Hello Priya! See exactly where your fees create value 👇",
                    "widgets": [
                        { "type": "pieChart", "title": "Your Annual Fee Allocation", "data": [
                            { "label": "Academics", "value": 40 }, { "label": "Facilities", "value": 25 }, { "label": "Scholarships", "value": 20 }, { "label": "Clubs & Activities", "value": 15 }
                        ]},
                        { "type": "barChart", "title": "Fest Budget Manager: 'Cognitia'", "data": [
                            { "label": "Budget", "value": 500000 }, { "label": "Spent", "value": 320000 }, { "label": "Remaining", "value": 180000 }
                        ]},
                        { "type": "detailedAuditTrail", "title": "Expenditures Funded by Your Fee Batch", "entries": [
                            { "transactionId": "TXN_LAB_01", "item": "Dept. of Science Lab Equipment", "amount": 200000, "status": "Verified ✅" }
                        ]}
                    ]
                }
            },
            "transactionRepository": {
                "TXN_LAB_01": {
                    "overview": { "type": "Expenditure", "from": "Project: Lab Upgrade", "to": "Vendor: EquipPro", "amount": { "value": 200000, "currency": "INR" }, "status": "PAID & VERIFIED", "timestamp": "2025-08-10T12:00:00Z" },
                    "onChainData": { "ledgerAction": "ApprovePayment", "approverIdentity": "HOD_Science@uvce.edu" },
                    "documentVerification": { "documentName": "Invoice_EP456.pdf", "ipfsCid": "QmXYZ...123", "retrievalStatus": "SUCCESS", "integrityCheck": "PASSED" },
                    "anomalyAnalysis": { "isAnomaly": false, "reason": null, "recommendation": null },
                    "communityForum": { "threads": [{ "queryId": "q2", "user": "StudentRep_04", "query": "Is there a warranty included?", "response": "Yes, a 3-year comprehensive warranty is included as per the attached IPFS document." }] }
                }
            },
            "gamification": {
                "communityHealthScore": 92,
                "leaderboard": [
                    { "rank": 1, "userName": "Ananya S. (Donor)", "points": 1500, "badge": "Impact Leader" },
                    { "rank": 2, "userName": "Priya K. (Student)", "points": 980, "badge": "Active Participant" }
                ],
                "quests": [
                    { "title": "Community Audit Challenge", "description": "Help verify 20 transactions this month to earn the 'Community Auditor' badge.", "progress": 18, "target": 20 }
                ]
            },
            "activityFeed": [
                { "timestamp": "2025-09-01T10:00:00Z", "log": "🗳 Student Council voted to allocate more to scholarships.", "type": "governance" },
                { "timestamp": "2025-08-28T16:00:00Z", "log": "⚠ AI ALERT: NGO vendor payment for 'Logistics' is 18% higher than the 6-month average.", "type": "alert", "severity": "medium", "actor": "AuraFlow AI" },
                { "timestamp": "2025-08-20T14:00:00Z", "log": "✅ Invoice verified and attached for Engineering Lab Project.", "type": "system" }
            ]
        };

        const { projectConfig, landingPage, viewContext, payload, transactionRepository, gamification, activityFeed } = jsonData;

        const contentArea = document.getElementById('content-area');
        const modal = document.getElementById('transaction-modal');
        const modalContent = document.getElementById('modal-content');
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotWindow = document.getElementById('chatbot-window');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');

        let activeCharts = [];

        // --- GNEWS API INTEGRATION ---
        const fetchNews = async () => {
            // IMPORTANT: Replace with your actual GNews API key.
            const apiKey = '9f9a725cf16c160da14a55bca1879d57'; 
            const newsContainer = document.getElementById('news-section-container');
            
            if (apiKey === '9f9a725cf16c160da14a55bca1879d57c') {
                newsContainer.innerHTML = `
                    <div class="text-center bg-foreground/50 p-6 rounded-2xl">
                        <h3 class="text-xl font-bold text-highlight">News Service Not Configured</h3>
                        <p class="text-secondary mt-2">Please add a valid GNews API key in the script to see live news.</p>
                    </div>`;
                return;
            }

            const query = encodeURIComponent('"financial transparency" OR "digital ledger" OR "public funds" OR "fintech india"');
            const url = `https://gnews.io/api/v4/search?q=${query}&lang=en&country=in&max=3&token=${apiKey}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`GNews API error! Status: ${response.status}`);
                }
                const data = await response.json();
                newsContainer.innerHTML = createNewsSectionHTML(data.articles);
            } catch (error) {
                console.error("Failed to fetch news:", error);
                newsContainer.innerHTML = `
                    <div class="text-center bg-foreground/50 p-6 rounded-2xl">
                         <h3 class="text-xl font-bold text-danger">Could Not Load News</h3>
                         <p class="text-secondary mt-2">There was an issue fetching the latest news. Please try again later.</p>
                    </div>`;
            }
        };

        // --- GEMINI API INTEGRATION ---
        // This function is now used for the chatbot
        const getChatbotResponse = async (userMessage) => {
            addMessageToChat('bot', '', true); // Show typing indicator

            const systemInstruction = `You are AuraFlow Assistant, a helpful AI guide for the AuraFlow financial transparency platform. Your purpose is to help users understand financial data related to their institution. Be concise, friendly, and focus on explaining the financial concepts and data presented to you. Use the provided data context to answer user questions accurately. Do not invent data. If you don't know the answer from the context, say that you cannot find that information. Analyze the data to provide insights where possible.`;
            
            const prompt = `Based on the following JSON data for the current user's view, please answer the user's question.
        
Data Context: 
${JSON.stringify(payload.studentView, null, 2)}

User Question: "${userMessage}"`;
            
            const apiKey = "AIzaSyB7TrfwZMMothhbuoKtvmZgd9YxwnYQH5c"; // Left empty for environment injection
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const apiPayload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { "temperature": 0.5, "topP": 0.95, "topK": 40 }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(apiPayload)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                // Update the typing indicator with the actual message
                const typingIndicator = chatMessages.querySelector('.typing-indicator-container');
                if (typingIndicator) {
                    typingIndicator.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-accent flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-5 h-5"></i></div>
                        <div class="bg-accent/20 p-3 rounded-lg max-w-xs text-sm">
                            <p>${text ? text.replace(/\n/g, '<br>') : "Sorry, I couldn't generate a response."}</p>
                        </div>
                    `;
                    typingIndicator.classList.remove('typing-indicator-container');
                    lucide.createIcons();
                }
                
            } catch (error) {
                console.error("Gemini API call failed:", error);
                 const typingIndicator = chatMessages.querySelector('.typing-indicator-container');
                if (typingIndicator) {
                     typingIndicator.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-danger/50 flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-5 h-5"></i></div>
                        <div class="bg-danger/20 p-3 rounded-lg max-w-xs text-sm">
                            <p>Sorry, I'm having trouble connecting right now.</p>
                        </div>
                    `;
                    typingIndicator.classList.remove('typing-indicator-container');
                    lucide.createIcons();
                }
            }
        };

        // --- THEME MANAGER ---
        const setupTheme = () => {
            // Logo element has been removed.
        };
        
        // --- HEADER & GLOBAL UI ---
        const setupHeader = () => {
            document.title = projectConfig.projectName;
            document.querySelector('link[rel="icon"]').href = projectConfig.branding.faviconUrl;
            // Project name and tagline elements have been removed.
        };

        // --- CHARTING ---
        const renderChart = (canvasId, type, title, data, colors) => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const chartConfig = {
                type: type,
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        label: title,
                        data: data.map(d => d.value),
                        backgroundColor: colors,
                        borderColor: 'var(--foreground)',
                        borderWidth: type === 'pie' || type === 'doughnut' ? 4 : 1,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: type.includes('bar') ? 'top' : 'right',
                            labels: {
                                color: 'var(--text-secondary)',
                                font: {
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        title: { display: false }
                    },
                    scales: type.includes('bar') ? {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(209, 250, 229, 0.1)' },
                            ticks: { color: 'var(--text-secondary)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--text-secondary)' }
                        }
                    } : {}
                }
            };
            activeCharts.push(new Chart(ctx, chartConfig));
        };

        // --- VIEW RENDERING ---
        const renderLandingPage = () => {
            clearDashboard();
            const { hero } = landingPage;
            contentArea.innerHTML = `
                <div class="text-center py-16 sm:py-24 animate-slide-up">
                    <h1 class="text-4xl sm:text-6xl font-extrabold tracking-tight text-primary">${hero.headline}</h1>
                    <p class="mt-4 max-w-2xl mx-auto text-lg text-secondary">${hero.subheadline}</p>
                    <div class="mt-8 flex justify-center items-center flex-wrap gap-4">
                        <a href="#" id="infographics-btn" class="btn-secondary-animated inline-flex items-center gap-2 bg-foreground/50 text-primary font-semibold py-3 px-8 rounded-lg">
                            <i data-lucide="pie-chart" class="w-5 h-5"></i>
                            <span>View Infographics</span>
                        </a>
                        <a href="public-ledger" class="btn-secondary-animated inline-flex items-center gap-2 bg-foreground/50 text-primary font-semibold py-3 px-8 rounded-lg">
                            <i data-lucide="book-open-check" class="w-5 h-5"></i>
                            <span>Public Ledger</span>
                        </a>
                        <a href="community-feedback" class="btn-secondary-animated inline-flex items-center gap-2 bg-foreground/50 text-primary font-semibold py-3 px-8 rounded-lg">
                            <i data-lucide="messages-square" class="w-5 h-5"></i>
                            <span>Community Forum</span>
                        </a>
                        <a href="chatbot" id="personal-chatbot-btn" class="btn-secondary-animated inline-flex items-center gap-2 bg-foreground/50 text-primary font-semibold py-3 px-8 rounded-lg">
                            <i data-lucide="bot" class="w-5 h-5"></i>
                            <span>Personal Chatbot</span>
                        </a>
                    </div>
                </div>
                <div id="news-section-container" class="mt-16 animate-slide-up" style="animation-delay: 200ms;">
                    <h2 class="text-3xl font-bold text-center text-primary mb-8">Latest News on Financial Transparency</h2>
                    <div class="flex justify-center items-center h-40">
                        <div class="loader"></div>
                    </div>
                </div>
            `;
            document.getElementById('infographics-btn').addEventListener('click', (e) => {
                e.preventDefault();
                renderDashboard(viewContext.userType);
            });
            fetchNews(); // Fetch news after rendering the landing page structure
            lucide.createIcons();
        };
        
        const createNewsSectionHTML = (articles) => {
            if (!articles || articles.length === 0) return `
                <div class="text-center bg-foreground/50 p-6 rounded-2xl">
                    <h3 class="text-xl font-bold text-primary">No Relevant News Found</h3>
                    <p class="text-secondary mt-2">We couldn't find any recent news matching our criteria.</p>
                </div>`;

            return `
                <h2 class="text-3xl font-bold text-center text-primary mb-8">Latest News</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    ${articles.map((item, index) => `
                        <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="block bg-foreground/50 backdrop-blur-sm rounded-2xl flex flex-col overflow-hidden card-glow" style="animation-delay: ${index * 100}ms;">
                            <img src="${item.image}" alt="${item.title}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1e293b/f8fafc?text=News';">
                            <div class="p-6 flex flex-col flex-grow">
                                <h3 class="text-lg font-bold text-primary">${item.title}</h3>
                                <div class="flex items-center text-xs text-secondary mt-2 mb-4">
                                    <span>${item.source.name}</span>
                                    <span class="mx-2">•</span>
                                    <span>${new Date(item.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                </div>
                                <p class="text-sm text-secondary flex-grow">${item.description}</p>
                            </div>
                        </a>
                    `).join('')}
                </div>
            `;
        };

        const clearDashboard = () => {
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            contentArea.innerHTML = '';
        };

        const renderDashboard = (userType) => {
            clearDashboard();
            
            const viewData = payload[`${userType}View`];
            const { welcomeMessage, widgets } = viewData;
            contentArea.innerHTML = `
                <div class="p-6 bg-foreground rounded-2xl mb-8 animate-slide-up flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-primary">${welcomeMessage}</h2>
                    <div class="flex items-center space-x-3">
                        <span class="text-secondary">${viewContext.userProfile.name}</span>
                        <img src="${viewContext.userProfile.avatarUrl}" alt="User Avatar" class="w-12 h-12 rounded-full border-2 border-accent">
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        ${widgets.map((widget, i) => createWidgetHTML(widget, i)).join('')}
                    </div>
                    <div class="space-y-8">
                        ${createGamificationHTML(gamification)}
                        ${createActivityFeedHTML(activityFeed)}
                    </div>
                </div>
            `;
            widgets.forEach(widget => {
                if (widget.type.toLowerCase().includes('chart')) {
                    const colors = ['#22c55e', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899'];
                    renderChart(`chart-${widget.title.replace(/\s+/g, '-')}`, widget.type.replace('Chart', ''), widget.title, widget.data, colors);
                }
            });
            document.querySelectorAll('.transaction-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderTransactionModal(e.currentTarget.dataset.txid);
                });
            });
            lucide.createIcons();
        };

        const createWidgetHTML = (widget, index) => {
            const delay = index * 100;
            let content = '';
            const widgetId = `chart-${widget.title.replace(/\s+/g, '-')}`;

            switch (widget.type) {
                case 'pieChart':
                    content = `<div class="h-80"><canvas id="${widgetId}"></canvas></div>`;
                    break;
                case 'barChart':
                    content = `<div class="h-80"><canvas id="${widgetId}"></canvas></div>`;
                    break;
                case 'detailedAuditTrail':
                    content = `
                        <ul class="space-y-3 mt-4">
                            ${widget.entries.map(entry => `
                                <li class="flex justify-between items-center p-3 bg-foreground/50 backdrop-blur-sm rounded-lg hover:bg-accent/10 transition-colors">
                                    <div>
                                        <p class="font-semibold text-primary">${entry.item}</p>
                                        <a href="#" data-txid="${entry.transactionId}" class="transaction-link text-xs text-accent hover:underline">ID: ${entry.transactionId}</a>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-primary">₹${entry.amount.toLocaleString('en-IN')}</p>
                                        <p class="text-sm text-green-500 font-medium">${entry.status}</p>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>`;
                    break;
            }
            return `<div class="bg-foreground p-6 rounded-2xl animate-slide-up card-glow" style="animation-delay: ${delay}ms;">
                        <h3 class="text-xl font-bold text-primary">${widget.title}</h3>
                        ${content}
                    </div>`;
        };
        
        const createGamificationHTML = (gamificationData) => {
            const { leaderboard, quests } = gamificationData;
            return `
                <div class="bg-foreground p-6 rounded-2xl animate-slide-up card-glow" style="animation-delay: 200ms;">
                    <h3 class="text-xl font-bold text-primary mb-4">Community Leaderboard</h3>
                     <ul class="space-y-3">
                        ${leaderboard.map(user => `<li class="flex items-center justify-between text-sm">
                                <div class="flex items-center"><span class="font-bold w-6">${user.rank}.</span><span>${user.userName}</span></div>
                                <span class="font-semibold text-accent">${user.points.toLocaleString()} pts</span>
                            </li>`).join('')}
                     </ul>
                     <div class="mt-6">
                        <h4 class="text-lg font-bold text-primary mb-2">${quests[0].title}</h4>
                        <p class="text-sm text-secondary mb-2">${quests[0].description}</p>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-accent h-2.5 rounded-full" style="width: ${(quests[0].progress / quests[0].target) * 100}%"></div>
                        </div>
                        <p class="text-xs text-right mt-1 text-secondary">${quests[0].progress} / ${quests[0].target} Verified</p>
                     </div>
                </div>`;
        }

        const createActivityFeedHTML = (feedData) => {
            const getIcon = (type, severity) => {
                if(type === 'alert') return `<i data-lucide="alert-triangle" class="${severity === 'medium' ? 'text-highlight' : 'text-danger'} w-5 h-5"></i>`;
                if(type === 'governance') return `<i data-lucide="landmark" class="text-secondary w-5 h-5"></i>`;
                return `<i data-lucide="check-circle-2" class="text-accent w-5 h-5"></i>`;
            }
            return `
                 <div class="bg-foreground p-6 rounded-2xl animate-slide-up card-glow" style="animation-delay: 300ms;">
                    <h3 class="text-xl font-bold text-primary mb-4">Activity Feed</h3>
                    <ul class="space-y-4">
                        ${feedData.map(item => `<li class="flex space-x-3">
                                <div class="flex-shrink-0">${getIcon(item.type, item.severity)}</div>
                                <div>
                                    <p class="text-sm text-primary">${item.log}</p>
                                    <p class="text-xs text-secondary">${new Date(item.timestamp).toLocaleString()}</p>
                                </div>
                           </li>`).join('')}
                    </ul>
                 </div>`;
        };

        const renderTransactionModal = (txId) => {
            const txData = transactionRepository[txId];
            if (!txData) return;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modalContent.innerHTML = `
                <button id="close-modal" class="absolute top-4 right-4 text-secondary hover:text-primary transition-colors"><i data-lucide="x"></i></button>
                <h2 class="text-2xl font-bold text-primary mb-1">Transaction Details</h2>
                <p class="text-sm text-accent font-mono mb-6">${txId}</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                    ${createModalStat('Status', txData.overview.status, 'shield-check', 'text-green-500')}
                    ${createModalStat('Amount', `₹${txData.overview.amount.value.toLocaleString('en-IN')}`, 'banknote')}
                    ${createModalStat('Type', txData.overview.type, 'arrow-right-left')}
                    ${createModalStat('Timestamp', new Date(txData.overview.timestamp).toLocaleDateString(), 'calendar')}
                </div>
                <div class="space-y-6">
                    ${createModalSection('Transaction Record', 'cpu', [{ label: 'Ledger Action', value: txData.onChainData.ledgerAction }, { label: 'Approver', value: txData.onChainData.approverIdentity }])}
                    ${createModalSection('Document Verification', 'file-check-2', [{ label: 'Document', value: txData.documentVerification.documentName }, { label: 'Document ID', value: `<span class="font-mono text-xs">${txData.documentVerification.ipfsCid}</span>` }, { label: 'Integrity Check', value: `<span class="font-semibold text-green-500">${txData.documentVerification.integrityCheck}</span>` }])}
                    ${createModalSection('Community Forum', 'message-square-more', `<div class="bg-foreground/50 p-3 rounded-lg"><p class="text-sm text-secondary">${txData.communityForum.threads[0].user}: "${txData.communityForum.threads[0].query}"</p><p class="text-sm text-primary mt-2 pl-4 border-l-2 border-accent"><strong>Response:</strong> ${txData.communityForum.threads[0].response}</p></div>`)}
                </div>`;
            document.getElementById('close-modal').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            lucide.createIcons();
        };

        const createModalStat = (label, value, icon, colorClass = 'text-accent') => `
            <div class="bg-foreground/50 backdrop-blur-sm p-3 rounded-lg">
                <i data-lucide="${icon}" class="w-6 h-6 mx-auto ${colorClass}"></i>
                <p class="text-sm font-semibold mt-2 text-primary">${value}</p>
                <p class="text-xs text-secondary">${label}</p>
            </div>`;

        const createModalSection = (title, icon, content) => `
            <div>
                <h3 class="text-lg font-bold text-primary flex items-center gap-2 mb-3">
                    <i data-lucide="${icon}" class="w-5 h-5 text-accent"></i>${title}
                </h3>
                ${typeof content === 'string' ? content : `<div class="text-sm space-y-2 pl-7">
                        ${content.map(item => `<div class="flex justify-between items-start">
                                <span class="text-secondary">${item.label}:</span>
                                <span class="text-primary text-right font-medium">${item.value}</span>
                            </div>`).join('')}
                    </div>`}
            </div>`;

        const closeModal = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modalContent.innerHTML = '';
        };

        // --- BACKGROUND CONSTELLATION ANIMATION ---
        const setupConstellation = () => {
            const canvas = document.getElementById('background-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let particles = [];
            const particleCount = window.innerWidth > 768 ? 100 : 40;
            const maxDistance = 120;
            let mouse = { x: null, y: null, radius: 150 };

            const resizeCanvas = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                initParticles(); // Re-initialize particles on resize to fit new screen
            };
            window.addEventListener('resize', resizeCanvas);

            window.addEventListener('mousemove', (event) => {
                mouse.x = event.x;
                mouse.y = event.y;
            });

            window.addEventListener('mouseout', () => {
                mouse.x = null;
                mouse.y = null;
            });
            
            class Particle {
                constructor(x, y, directionX, directionY, size, color) {
                    this.x = x;
                    this.y = y;
                    this.directionX = directionX;
                    this.directionY = directionY;
                    this.size = size;
                    this.color = color;
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                }
                update() {
                    if (this.x > canvas.width || this.x < 0) this.directionX = -this.directionX;
                    if (this.y > canvas.height || this.y < 0) this.directionY = -this.directionY;
                    
                    let dx = mouse.x - this.x;
                    let dy = mouse.y - this.y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < mouse.radius + this.size) {
                        if (mouse.x < this.x && this.x < canvas.width - this.size * 10) this.x += 2;
                        if (mouse.x > this.x && this.x > this.size * 10) this.x -= 2;
                        if (mouse.y < this.y && this.y < canvas.height - this.size * 10) this.y += 2;
                        if (mouse.y > this.y && this.y > this.size * 10) this.y -= 2;
                    }

                    this.x += this.directionX;
                    this.y += this.directionY;
                    this.draw();
                }
            }
            
            const initParticles = () => {
                particles = [];
                for (let i = 0; i < particleCount; i++) {
                    let size = Math.random() * 2 + 1;
                    let x = Math.random() * (canvas.width - size * 2) + size;
                    let y = Math.random() * (canvas.height - size * 2) + size;
                    let directionX = (Math.random() * 0.4) - 0.2;
                    let directionY = (Math.random() * 0.4) - 0.2;
                    let color = 'rgba(6, 182, 212, 0.7)';
                    particles.push(new Particle(x, y, directionX, directionY, size, color));
                }
            };
            
            const connectParticles = () => {
                for (let a = 0; a < particles.length; a++) {
                    for (let b = a; b < particles.length; b++) {
                        let distance = ((particles[a].x - particles[b].x) * (particles[a].x - particles[b].x)) +
                                       ((particles[a].y - particles[b].y) * (particles[a].y - particles[b].y));
                        if (distance < (maxDistance * maxDistance)) {
                            let opacity = 1 - (distance / (maxDistance * maxDistance));
                            ctx.strokeStyle = `rgba(209, 250, 229, ${opacity * 0.5})`;
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.moveTo(particles[a].x, particles[a].y);
                            ctx.lineTo(particles[b].x, particles[b].y);
                            ctx.stroke();
                        }
                    }
                }
            };

            const animate = () => {
                requestAnimationFrame(animate);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => p.update());
                connectParticles();
            };
            
            resizeCanvas(); // Initial setup
            animate();
        };

        // --- CHATBOT LOGIC ---
        const addMessageToChat = (sender, message, isTyping = false) => {
            const messageEl = document.createElement('div');
            messageEl.classList.add('flex', 'gap-2.5');

            if (isTyping) {
                messageEl.classList.add('typing-indicator-container');
                messageEl.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-accent flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-5 h-5"></i></div>
                    <div class="bg-accent/20 p-3 rounded-lg max-w-xs text-sm flex items-center typing-indicator">
                       <span></span><span></span><span></span>
                    </div>`;
            } else if (sender === 'user') {
                messageEl.classList.add('justify-end');
                messageEl.innerHTML = `
                     <div class="bg-accent p-3 rounded-lg max-w-xs text-sm">
                        <p>${message}</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-foreground/50 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="user" class="w-5 h-5 text-secondary"></i>
                    </div>`;
            } else { // bot
                // This case is handled by updating the typing indicator
            }
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lucide.createIcons();
        };

        const handleChatSubmit = (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            addMessageToChat('user', userMessage);
            chatInput.value = '';
            
            setTimeout(() => {
                getChatbotResponse(userMessage);
            }, 500);
        };
        
        // --- APP INITIALIZATION ---
        const init = () => {
            setupHeader();
            setupTheme();
            setupConstellation();
            renderLandingPage();

            // Chatbot event listeners
            chatbotToggle.addEventListener('click', () => {
                chatbotWindow.classList.toggle('hidden');
                if(!chatbotWindow.classList.contains('hidden')) {
                    chatInput.focus();
                }
            });
            chatbotClose.addEventListener('click', () => chatbotWindow.classList.add('hidden'));
            chatForm.addEventListener('submit', handleChatSubmit);

            lucide.createIcons();
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>


